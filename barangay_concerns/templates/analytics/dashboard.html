{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Barangay Connect{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-4">
        <div>
            <h6 class="text-secondary text-uppercase fw-bold letter-spacing-wide mb-1 text-xs">Admin Overview</h6>
            <h1 class="display-6 fw-bold text-gradient mb-0">Analytics Dashboard</h1>
        </div>
        <a href="{% url 'analytics:export' %}" class="btn btn-secondary">
            <i data-lucide="download" class="icon-sm"></i> Export CSV
        </a>
    </div>

    <!-- 1. Stats Grid -->
    <div class="row g-4 mb-5">
        <!-- Total -->
        <div class="col-sm-6 col-lg-4">
            <div class="card border-0 shadow-sm h-100 transition-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary fw-medium text-uppercase text-xs mb-1">Total Reports</p>
                            <h2 class="display-6 fw-bold mb-0 text-dark">{{ total_concerns }}</h2>
                        </div>
                        <div class="bg-indigo-subtle text-primary rounded-circle p-3">
                            <i data-lucide="folder-open" class="icon-md"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending -->
        <div class="col-sm-6 col-lg-4">
            <div class="card border-0 shadow-sm h-100 transition-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary fw-medium text-uppercase text-xs mb-1">Pending Action</p>
                            <h2 class="display-6 fw-bold mb-0 text-warning">{{ pending_count }}</h2>
                        </div>
                        <div class="bg-warning-subtle text-warning rounded-circle p-3">
                            <i data-lucide="clock" class="icon-md"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- In Progress -->
        <div class="col-sm-6 col-lg-4">
            <div class="card border-0 shadow-sm h-100 transition-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary fw-medium text-uppercase text-xs mb-1">In Progress</p>
                            <h2 class="display-6 fw-bold mb-0 text-info">{{ in_progress_count }}</h2>
                        </div>
                        <div class="bg-info-subtle text-info rounded-circle p-3">
                            <i data-lucide="loader-2" class="icon-md"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resolved -->
        <div class="col-sm-6 col-lg-4">
            <div class="card border-0 shadow-sm h-100 transition-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary fw-medium text-uppercase text-xs mb-1">Resolved</p>
                            <h2 class="display-6 fw-bold mb-0 text-success">{{ resolved_count }}</h2>
                        </div>
                        <div class="bg-success-subtle text-success rounded-circle p-3">
                            <i data-lucide="check-circle-2" class="icon-md"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Archived (Clickable) -->
        <div class="col-sm-6 col-lg-4">
            <a href="{% url 'concerns:archive_list' %}" class="card border-0 shadow-sm h-100 transition-hover text-decoration-none">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary fw-medium text-uppercase text-xs mb-1">Archived</p>
                            <h2 class="display-6 fw-bold mb-0 text-secondary">{{ archived_count }}</h2>
                        </div>
                        <div class="bg-light text-secondary rounded-circle p-3">
                            <i data-lucide="archive" class="icon-md"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <!-- Resolution Rate -->
        <div class="col-sm-6 col-lg-4">
            <div class="card border-0 shadow-sm h-100 transition-hover bg-gradient-subtle-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-primary fw-medium text-uppercase text-xs mb-1">Resolution Rate</p>
                            <h2 class="display-6 fw-bold mb-0 text-primary">{{ resolution_rate }}%</h2>
                        </div>
                        <div class="bg-white text-primary rounded-circle p-3 shadow-sm">
                            <i data-lucide="trending-up" class="icon-md"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Charts Grid -->
    <div class="row g-4 mb-4">
        <!-- Main Trend -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header border-0 bg-white pt-4 px-4 pb-0">
                    <h5 class="fw-bold mb-0">Report Trends</h5>
                    <small class="text-secondary">Last 30 Days Activity</small>
                </div>
                <div class="card-body p-4">
                    <canvas id="trendChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Status Doughnut -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header border-0 bg-white pt-4 px-4 pb-0">
                    <h5 class="fw-bold mb-0">Status Distribution</h5>
                    <small class="text-secondary">Current Workload</small>
                </div>
                <div class="card-body p-4 d-flex align-items-center justify-content-center">
                    <div style="height: 250px; width: 100%;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Bar -->
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header border-0 bg-white pt-4 px-4 pb-0">
                    <h5 class="fw-bold mb-0">Issues by Category</h5>
                    <small class="text-secondary">Topic Frequency</small>
                </div>
                <div class="card-body p-4">
                    <canvas id="categoryChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Data -->
{{ category_labels|json_script:"category-labels" }}
{{ category_data|json_script:"category-data" }}
{{ status_labels|json_script:"status-labels" }}
{{ status_data|json_script:"status-data" }}
{{ trend_labels|json_script:"trend-labels" }}
{{ trend_data|json_script:"trend-data" }}

<script>
    // New Colors (V2)
    const colors = {
        primary: '#4f46e5', // Indigo 600
        primaryLight: '#c7d2fe', // Indigo 200
        success: '#10b981', // Emerald 500
        warning: '#f59e0b', // Amber 500
        danger: '#ef4444',  // Red 500
        info: '#3b82f6',    // Blue 500
        slate: '#94a3b8'    // Slate 400
    };

    const getData = (id) => JSON.parse(document.getElementById(id).textContent);

    // Config Defaults
    Chart.defaults.font.family = 'Inter';
    Chart.defaults.color = '#64748b';

    // 1. Trend (Line with Gradient)
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const gradient = trendCtx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(79, 70, 229, 0.2)');
    gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: getData('trend-labels'),
            datasets: [{
                label: 'Reports',
                data: getData('trend-data'),
                borderColor: colors.primary,
                backgroundColor: gradient,
                borderWidth: 2,
                pointBackgroundColor: colors.primary,
                pointRadius: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                x: { grid: { display: false } }
            }
        }
    });

    // 2. Status (Doughnut)
    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: getData('status-labels'),
            datasets: [{
                data: getData('status-data'),
                backgroundColor: [colors.danger, colors.warning, colors.success, colors.slate],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } }
            }
        }
    });

    // 3. Category (Bar)
    new Chart(document.getElementById('categoryChart'), {
        type: 'bar',
        data: {
            labels: getData('category-labels'),
            datasets: [{
                label: 'Concerns',
                data: getData('category-data'),
                backgroundColor: colors.primary,
                borderRadius: 4,
                barThickness: 20
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { display: false } },
                x: { grid: { display: false } }
            }
        }
    });
</script>
{% endblock %}