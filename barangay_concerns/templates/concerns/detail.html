<!-- templates/concerns/detail.html -->
{% extends 'base.html' %}

{% block title %}{{ concern.title }} - Barangay Concerns{% endblock %}

{% block content %}
<div class="container">
    <!-- Lock Warning for Regular Users -->
    {% if concern.is_locked and not user.is_lgu %}
    <div class="alert alert-warning" style="margin-bottom: 2rem;">
        <span class="alert-icon">üîí</span>
        <span class="alert-text">
            <strong>This concern is locked.</strong> It is currently being processed by LGU staff and cannot be edited.
        </span>
    </div>
    {% endif %}

    <!-- Archive Notice -->
    {% if concern.is_archived %}
    <div class="alert alert-info" style="margin-bottom: 2rem;">
        <span class="alert-icon">üì¶</span>
        <span class="alert-text">
            <strong>This concern is archived.</strong> 
            Archived on {{ concern.archived_at|date:"F d, Y" }} by {{ concern.archived_by.username }}.
            {% if user.is_lgu %}
            <a href="{% url 'concerns:unarchive' concern.pk %}" style="color: white; text-decoration: underline; margin-left: 1rem;">Restore from Archive</a>
            {% endif %}
        </span>
    </div>
    {% endif %}

    <div class="page-header">
        <div>
            <h1>{{ concern.title }}</h1>
            <p class="page-subtitle">Reported on {{ concern.created_at|date:"F d, Y" }}</p>
            
            <!-- Lock Status Badge -->
            {% if concern.is_locked %}
            <span class="badge" style="background: #f59e0b; color: white; margin-top: 0.5rem;">
                üîí Locked - Being Processed
            </span>
            {% endif %}
        </div>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <!-- Edit button - only if not locked or user is LGU -->
            {% if not concern.is_archived %}
                {% if user.is_lgu or concern.reporter == user and concern.status == 'PENDING' and not concern.is_locked %}
                <a href="{% url 'concerns:update' concern.pk %}" class="btn btn-primary">‚úèÔ∏è Edit</a>
            {% endif %}
                
                <!-- Archive button (replaces delete) - LGU only -->
            {% if user.is_lgu %}
                <a href="{% url 'concerns:delete' concern.pk %}" class="btn" style="background: #f59e0b; color: white;">üì¶ Archive</a>
            {% endif %}
            {% endif %}
            
            <a href="{% url 'concerns:list' %}" class="btn btn-outline">‚Üê Back to List</a>
        </div>
    </div>

    <div class="concern-detail-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        <!-- Main Content -->
        <div style="display: flex; flex-direction: column; gap: 2rem;">
            <!-- Image -->
            {% if concern.image %}
            <div class="card">
                <div class="card-body">
                    <img src="{{ concern.image.url }}" alt="{{ concern.title }}" style="width: 100%; border-radius: var(--border-radius); max-height: 500px; object-fit: cover;">
                </div>
            </div>
            {% endif %}

            <!-- Description -->
            <div class="card">
                <div class="card-header">
                    <h3>üìã Description</h3>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-secondary); line-height: 1.8; white-space: pre-wrap;">{{ concern.description }}</p>
                </div>
            </div>

            <!-- Location Map -->
            {% if concern.latitude and concern.longitude %}
            <div class="card">
                <div class="card-header">
                    <h3>üìç Location on Map</h3>
                </div>
                <div class="card-body">
                    <div id="detailMap" style="height: 400px; border-radius: var(--border-radius); overflow: hidden;"></div>
                </div>
            </div>
            {% endif %}

            <!-- LGU Status Update Section - Only show if NOT archived -->
            {% if user.is_lgu and not concern.is_archived %}
            <div class="card" style="border: 2px solid var(--primary); box-shadow: 0 0 30px rgba(99, 102, 241, 0.2);">
                <div class="card-header" style="background: rgba(99, 102, 241, 0.1); border-bottom: 2px solid var(--primary);">
                    <h3 style="color: var(--primary);">üõ†Ô∏è LGU Actions & Status Management</h3>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'concerns:update_status' concern.pk %}">
                        {% csrf_token %}
                        
                        <div class="form-grid-2">
                            <div class="form-field">
                                <label class="form-label">Status <span class="required">*</span></label>
                                <select name="status" class="form-input" required>
                                    <option value="PENDING" {% if concern.status == 'PENDING' %}selected{% endif %}>‚è≥ Pending</option>
                                    <option value="IN_PROGRESS" {% if concern.status == 'IN_PROGRESS' %}selected{% endif %}>üîÑ In Progress</option>
                                    <option value="RESOLVED" {% if concern.status == 'RESOLVED' %}selected{% endif %}>‚úÖ Resolved</option>
                                    <option value="CLOSED" {% if concern.status == 'CLOSED' %}selected{% endif %}>üîí Closed</option>
                                </select>
                                <span class="help-text">
                                    {% if concern.status == 'PENDING' %}
                                    ‚ö†Ô∏è Changing from PENDING will lock this concern for the reporter.
                                    {% endif %}
                                </span>
                            </div>

                            <div class="form-field">
                                <label class="form-label">Priority <span class="required">*</span></label>
                                <select name="priority" class="form-input" required>
                                    <option value="LOW" {% if concern.priority == 'LOW' %}selected{% endif %}>üü¢ Low</option>
                                    <option value="MEDIUM" {% if concern.priority == 'MEDIUM' %}selected{% endif %}>üü° Medium</option>
                                    <option value="HIGH" {% if concern.priority == 'HIGH' %}selected{% endif %}>üü† High</option>
                                    <option value="URGENT" {% if concern.priority == 'URGENT' %}selected{% endif %}>üî¥ Urgent</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-field">
                            <label class="form-label">Admin Notes (Optional)</label>
                            <textarea name="admin_notes" class="form-input" rows="3" placeholder="Add internal notes about actions taken or plans for this concern..."></textarea>
                            <span class="help-text">These notes are for internal tracking purposes</span>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-primary">
                                üíæ Update Status & Priority
                            </button>
                            
                            {% if concern.status != 'RESOLVED' %}
                            <button type="submit" name="quick_action" value="resolve" class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);">
                                ‚úÖ Mark as Resolved
                            </button>
                            {% endif %}
                            
                            {% if concern.status != 'CLOSED' %}
                            <button type="submit" name="quick_action" value="close" class="btn" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; box-shadow: 0 4px 15px rgba(100, 116, 139, 0.4);" 
                                onclick="return confirm('Closing will hide this concern from the map and list. Continue?')">
                                üîí Close Concern
                            </button>
                            {% endif %}
                        </div>

                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.05); border-radius: var(--border-radius); border-left: 4px solid var(--primary);">
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">
                                <strong>üìå Important:</strong> 
                                ‚Ä¢ Changing from PENDING locks the concern for the reporter.
                                ‚Ä¢ CLOSED concerns will disappear from map and list views.
                                ‚Ä¢ Use "Archive" to soft-delete concerns.
                            </p>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div style="display: flex; flex-direction: column; gap: 2rem;">
            <!-- Status Card -->
            <div class="card">
                <div class="card-header">
                    <h3>üìä Current Status</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div>
                            <span class="form-label">Status</span>
                            <div style="margin-top: 0.5rem;">
                                <span class="badge badge-status-{{ concern.status|lower }}" style="font-size: 1rem; padding: 0.5rem 1.5rem; display: inline-block;">
                                    {{ concern.get_status_display }}
                                </span>
                            </div>
                        </div>
                        
                        <div>
                            <span class="form-label">Priority Level</span>
                            <div style="margin-top: 0.5rem;">
                                <span class="concern-priority priority-{{ concern.priority|lower }}" style="font-size: 1rem; padding: 0.5rem 1.5rem; display: inline-block;">
                                    {{ concern.get_priority_display }}
                                </span>
                            </div>
                        </div>

                        <!-- Lock Status Info -->
                        <div>
                            <span class="form-label">Editable Status</span>
                            <div style="margin-top: 0.5rem;">
                                {% if concern.is_locked %}
                                    <span class="badge" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 2px solid #f59e0b;">
                                        üîí Locked
                                    </span>
                                {% else %}
                                    <span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981; border: 2px solid #10b981;">
                                        ‚úì Unlocked
                                    </span>
                                {% endif %}
                            </div>
                            {% if concern.is_locked %}
                            <p style="color: var(--text-tertiary); font-size: 0.85rem; margin-top: 0.5rem;">
                                This concern is being processed by LGU staff.
                            </p>
                            {% endif %}
                        </div>

                        {% if concern.resolved_at %}
                        <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: var(--border-radius); border-left: 4px solid var(--accent-green);">
                            <span class="form-label">Resolved Date</span>
                            <p style="color: var(--accent-green); margin-top: 0.5rem; font-weight: 600;">{{ concern.resolved_at|date:"F d, Y h:i A" }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Category Card -->
            <div class="card">
                <div class="card-header">
                    <h3>üè∑Ô∏è Category</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 3rem;">{{ concern.get_category_icon }}</span>
                        <div>
                            <span class="badge badge-{{ concern.category|lower }}" style="font-size: 1rem; padding: 0.5rem 1.5rem; display: inline-block;">
                                {{ concern.get_category_display }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Details -->
            <div class="card">
                <div class="card-header">
                    <h3>üìç Location Details</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <span class="form-label">Address</span>
                            <p style="color: var(--text-secondary); margin-top: 0.25rem;">{{ concern.location }}</p>
                        </div>
                        <div>
                            <span class="form-label">Barangay</span>
                            <p style="color: var(--text-secondary); margin-top: 0.25rem;">{{ concern.barangay }}</p>
                        </div>
                        <div>
                            <span class="form-label">Municipality</span>
                            <p style="color: var(--text-secondary); margin-top: 0.25rem;">{{ concern.municipality }}</p>
                        </div>
                        {% if concern.latitude and concern.longitude %}
                        <div>
                            <span class="form-label">Coordinates</span>
                            <p style="color: var(--text-secondary); margin-top: 0.25rem; font-family: monospace; font-size: 0.9rem;">
                                {{ concern.latitude }}, {{ concern.longitude }}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Reporter Info -->
            <div class="card">
                <div class="card-header">
                    <h3>üë§ Reported By</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <span class="form-label">Name</span>
                            <p style="color: var(--text-secondary); margin-top: 0.25rem;">{{ concern.reporter.get_full_name|default:concern.reporter.username }}</p>
                        </div>
                        <div>
                            <span class="form-label">Email</span>
                            <p style="color: var(--text-secondary); margin-top: 0.25rem;">{{ concern.reporter.email }}</p>
                        </div>
                        {% if concern.reporter.phone_number %}
                        <div>
                            <span class="form-label">Phone</span>
                            <p style="color: var(--text-secondary); margin-top: 0.25rem;">{{ concern.reporter.phone_number }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card">
                <div class="card-header">
                    <h3>üïê Timeline</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <span class="form-label">Created</span>
                            <p style="color: var(--text-secondary); margin-top: 0.25rem;">{{ concern.created_at|date:"F d, Y h:i A" }}</p>
                        </div>
                        <div>
                            <span class="form-label">Last Updated</span>
                            <p style="color: var(--text-secondary); margin-top: 0.25rem;">{{ concern.updated_at|date:"F d, Y h:i A" }}</p>
                        </div>
                        {% if concern.is_archived %}
                        <div style="padding: 1rem; background: rgba(100, 116, 139, 0.1); border-radius: var(--border-radius); border-left: 4px solid #64748b;">
                            <span class="form-label">Archived</span>
                            <p style="color: #64748b; margin-top: 0.5rem; font-weight: 600;">
                                {{ concern.archived_at|date:"F d, Y h:i A" }}
                            </p>
                            <p style="color: var(--text-tertiary); font-size: 0.85rem; margin-top: 0.25rem;">
                                By {{ concern.archived_by.username }}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if concern.latitude and concern.longitude %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var lat = parseFloat('{{ concern.latitude }}');
        var lng = parseFloat('{{ concern.longitude }}');
        
        var map = L.map('detailMap').setView([lat, lng], 16);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        var markerColor = '{{ concern.get_marker_color }}';
        var categoryIcon = '{{ concern.get_category_icon|escapejs }}';
        var concernTitle = '{{ concern.title|escapejs }}';
        var concernLocation = '{{ concern.location|escapejs }}';
        
        var markerIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: ' + markerColor + '; width: 40px; height: 40px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 4px solid white; box-shadow: 0 4px 20px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;">' +
                    '<span style="transform: rotate(45deg); font-size: 20px;">' + categoryIcon + '</span>' +
                  '</div>',
            iconSize: [40, 40],
            iconAnchor: [20, 40]
        });
        
        L.marker([lat, lng], { icon: markerIcon }).addTo(map)
            .bindPopup(
                '<div style="min-width: 200px;">' +
                    '<h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; color: #333;">' + concernTitle + '</h3>' +
                    '<p style="margin: 0; color: #666;">' + concernLocation + '</p>' +
                '</div>'
            ).openPopup();
    });
</script>
{% endif %}

<style>
.badge-status-pending { 
    background: rgba(251, 191, 36, 0.25); 
    color: #fcd34d; 
    border: 1px solid rgba(251, 191, 36, 0.4); 
}
.badge-status-in_progress { 
    background: rgba(96, 165, 250, 0.25); 
    color: #93c5fd; 
    border: 1px solid rgba(96, 165, 250, 0.4); 
}
.badge-status-resolved { 
    background: rgba(16, 185, 129, 0.25); 
    color: #6ee7b7; 
    border: 1px solid rgba(16, 185, 129, 0.4); 
}
.badge-status-closed { 
    background: rgba(100, 116, 139, 0.25); 
    color: #cbd5e1; 
    border: 1px solid rgba(100, 116, 139, 0.4); 
}

@media (max-width: 1024px) {
    .concern-detail-grid {
        grid-template-columns: 1fr !important;
    }
}
</style>
{% endblock %}